<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>restaurantology</title>
	<!--<script type="text/javascript" charset="utf-8" src="base64.js"></script>-->
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a3/jquery.mobile-1.0a3.min.css" />
	<link rel="stylesheet" href="../jquery-ui-1.8.11.custom/css/ui-lightness/jquery-ui-1.8.11.custom.css" />
	<style>
		body {
			padding: 5px 40px;
			font-family: Helvetica;
			background-image: url(bgstatic.light.png);
			background-color: #f9f9f9;
			min-width: 1020px;
		}
		
		h1 {
			font-size: 44px;
			line-height: 5px;
			margin-bottom: 0px;
			text-shadow: 0px 1px 0px #666;
			display: block;
		}
		
		h2 {
			font-size: 24px;
			font-weight: lighter;
			color: #444;
		}
		
		#controls {
			padding: 10px;
			margin-bottom: 20px;
			background-color: #eee;
			-moz-border-radius: 10px;
			-webkit-border-radius: 10px;
			border: 1px solid #ddd;
			color: #222;
		}
		
		#controls strong {
			display: inline-block;
			padding: 2px 5px;
			color: #DC0A8E;
		}
		
		#controls input {
			margin: 3px 15px;
			min-width: 200px;
			padding: 5px;
		}
		
		#controls #restaurant.loading {
			background-image: url(loading.round.gif);
			background-repeat: no-repeat;
			background-position: right center;
		}
		
		#mapContainer, #resultsList {
			width: 40%;
			display: inline-block;
			vertical-align: top;
		}
		
		#resultsList {
			padding: 0px 20px;
			list-style-type: none;
			margin-top: 0px;
			overflow-y: scroll;
			width: 54%;
			float: right;
			max-height: 400px;
		}
		
		#resultsList > li {
			padding: 10px 3px;
			margin-bottom: 10px;
		}
		
		#resultsList > li + li {
			border-top: 1px solid #ddd;
		}
		
		.resultCity {
			color: #999;
			font-size: 80%;
		}
		
		.resultItem strong {
			display: block;
			font-size: 150%;
		}
		
		.resultItem .resultContent {
			margin-top: 20px;
			min-height: 100px;
			padding: 5px;
		}
		
		.resultItem .tags {
			display: inline-block;
			width: 60%;
		}
		
		.resultItem img, .resultItem .dummyImg {
			padding: 3px;
			border: 1px solid #eee;
			vertical-align: top;
		}
		
		.resultItem .dummyImg {
			display: inline-block;
			background-color: #f5f5f5;
			width: 100px;
			height: 100px;
		}
		
		.linkToSite {
			font-size: 70%;
			color: #666;
		}
		
		.resultItem .tags li {
			display: inline-block;
			padding: 3px;
			background-color: #ddd;
			color: #444;
			margin: 3px;
		}
		
		.formFresh {
			color: #aaa;
		}
	</style>
	<script src="../jquery-ui-1.8.11.custom/js/jquery-1.5.1.min.js"></script>
	<script src="../jquery-ui-1.8.11.custom/js/jquery-ui-1.8.11.custom.min.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src="../geo-autocomplete/ui.geo_autocomplete.js"></script>
	<script type="text/javascript" charset="utf-8">

		(function () {
			$(".formFresh").live('click.formFresh', function () {
				var input = $(this);
				input.val("");
				input.removeClass("formFresh");
				input.die('.formFresh');
			})
		})();
	
		$(document).bind("mobileinit", function(){
		  	//apply overrides here
		});
		
		$(document).ready(function () {
			var convertHunchResults = function (list) {
				return $.map(list, function (e, i) {
					//console.log(e);
					return {
						label: e.name + (e.city ? " - " + e.city : ""),
						value: e.name,
						resultId: e.result_id,
						cuisines: e.cuisines
					};
				});
			},
			blinkMarker = function (marker) {
				return function () {
					//console.log(marker.getVisible());
					marker.getVisible() ? marker.setVisible(false) : marker.setVisible(true);
				}
			},
			drawRecResult = function (item, marker) {
				var title = $("<strong/>"),
					p = $("<div class='resultContent'/>"),
					link = $("<a class='linkToSite'/>"),
					img = $("<img width='100'/>"),
					li = $("<li class='resultItem'>"),
					tags = $("<ul class='tags'/>"),
					interval;
					
				li.hover(function () {
					interval = setInterval(blinkMarker(marker), 800);
				}, function () {
					clearInterval(interval);
					marker.setVisible(true);
				});
				
				li.append(title).append(link).append(p);
				
				title.text(item.name);
				link.attr("href", item.url).text(item.url);
				
				if (item.image_urls[0] && item.image_urls[0] != "") { 
					img.attr("src", item.image_urls[0]);
					p.append(img);
				}
				else 
					p.append("<div class='dummyImg'></div>");
				
				p.append(tags);
				
				$.each(item.tags, function (i,e) {
					tags.append("<li>"+e+"</li>");
				});
				
				return li;
			},
			pingHunch = function () {
				var params = {
						result_id: resultId,
						topic_ids: "list_restaurant",
						minlat: minLat,
						maxlat: maxLat,
						minlng: minLng,
						maxlng: maxLng,
						minimal: 'f',
						limit: 10
					},
					results = $("#resultsList").empty();
				
				//console.log(cuisine);
				if (cuisine && cuisine != "") params["tags"] = cuisine;
								
				$.each(markers, function (i,e) {
					e.setMap(null);
				});
				markers = [];
				
				$.ajax({
					url:  "http://api.hunch.com/api/v1/get-similar-results/",
					data: params,
					dataType: 'jsonp',
					success: function (data) {
						var list = $("#resultsList");
						if (data.total > 0) {
							$.each(data.results, function (i,e) {
								//console.log(e);
								var pos = new google.maps.LatLng(e.lat, e.lng),
									marker = new google.maps.Marker({
										map: map,
										title: e.name,
										position: pos
									});
									
								markers.push(marker);
								list.append(drawRecResult(e, marker));									
							});

							var latlngbounds = new google.maps.LatLngBounds( );
							for ( var i = 0; i < markers.length; i++ ) {
								latlngbounds.extend( markers[ i ].getPosition() );
							}
							map.fitBounds( latlngbounds );
						}
					}
				});	
			},
			markers = [],
			bounds,
			map,
			minLat = 0,
			minLng = 0,
			maxLat = 0,
			maxLng = 0,
			resultId,
			cuisine,
			viewport,
			location,
			center;

			$('#location').geo_autocomplete({
				maptype: 'roadmap',
				select: function(_event, _ui) {
					// console.log(_ui.item.viewport);
					//console.log(_ui.item.viewport.getCenter());
					// console.log(_ui.item.label);
					$("#location").val(_ui.item.label);
					if (_ui.item.viewport) {
						viewport = _ui.item.viewport;
						location = _ui.item.label;
						center = _ui.item.viewport.getCenter();
						maxLat = _ui.item.viewport.getNorthEast().lat();
						maxLng = _ui.item.viewport.getNorthEast().lng();
						minLat = _ui.item.viewport.getSouthWest().lat();
						minLng = _ui.item.viewport.getSouthWest().lng();
					}
				}
			});

			
			$( "#restaurant" ).autocomplete({
				search: function (event, ui) {
					$("#restaurant").addClass("loading");
				},
				select: function (event, ui) {
					resultId = ui.item.resultId;
					if (ui.item.cuisines) cuisine = ui.item.cuisines[0];
				},
				source: function (string, callback) {
					//callback([{label: "ok", value: "damn"}]);
					// console.log("http://api.hunch.com/api/v1/get-results/"+$.param({
					// 		name: string.term,
					// 		subword: "t",
					// 		topic_ids: "list_restaurant",
					// 		minimal: "t",
					// 		limit: 10
					// 	}));
					var finish = function () {
						$("#restaurant").removeClass("loading");
					};
					
					$.ajax({
						url: "http://api.hunch.com/api/v1/get-results/",
						data: {
							name: string.term,
							subword: "f",
							topic_ids: "list_restaurant",
							minimal: "f",
							limit: 10
						},
						dataType: 'jsonp',
						success: function (data) {
							finish();
							if (data.total > 0) {
								callback(convertHunchResults(data.results));
							}
							else callback([]);
						},
						error: finish
					})
				}
			});
			
			$("#lookup").click(function () {
				//$("#mapCanvas").show();
				//var bounds;
				
				if (!map) {
					map = new google.maps.Map(document.getElementById("mapCanvas"), { 
						mapTypeId: google.maps.MapTypeId.ROADMAP,
						center: center,
						zoom: 12,
						mapTypeControl: true
					});
					google.maps.event.addListenerOnce(map, 'tilesloaded', pingHunch);
				}
				else pingHunch();
			});

		});
	</script>
	<!--<script src="http://code.jquery.com/mobile/1.0a3/jquery.mobile-1.0a3.min.js"></script>-->
</head>
<body>

	<div data-role="page" >
		<div data-role="header">
			<h1>restaurantology</h1>
			<h2>a restaurant recommendation tool</h2>
		</div>
		<div data-role="content">
			<div id="controls">
				<div data-role="fieldcontain">
					<label for="slider">I am <strong>homesick</strong> for:</label>
				 	<input type="text" id="restaurant" value="restaurant name..." class="formFresh" />

					<label for="slider">and now I <strong>live</strong> in:</label>
				 	<input type="text" id="location" value="city name..." class="formFresh" />
					<button id="lookup">Get Recs</button>
				</div>
			</div>
			<div id="mapContainer">
				<div id="mapCanvas" style="width:400px;height:400px;"></div>
			</div>
			<ul id="resultsList">
			</ul>
		</div>
		<!--
		<div data-role="footer">
		</div>
		-->
	</div>

</body>
</html>
